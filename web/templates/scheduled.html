<!DOCTYPE html>
<html>
<head>
  <title>{{ if .IsGlobalView }}All Scheduled Webhooks{{ else }}Scheduled Webhooks for {{ .SubscriptionID }}{{ end }}</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js'></script>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <h2>{{ if .IsGlobalView }}All Scheduled Webhooks{{ else }}Scheduled Webhooks for Subscription {{ .SubscriptionID }}{{ end }}</h2>

  <div class="back-link">
      <a href="/ui/subscriptions">Back to Subscriptions List</a>
      {{ if not .IsGlobalView }}
          | <a href="/ui/subscriptions/{{ .SubscriptionID }}/scheduled/new">Schedule New for this Subscription</a>
      {{ end }}
  </div>

  <div id="calendar"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof FullCalendar === 'undefined') {
          console.error("FullCalendar library not loaded!");
          alert("Error: Calendar library failed to load.");
          return;
      }

      var subscriptionId = "{{ .SubscriptionID }}";
      var isGlobalView = "{{ .IsGlobalView }}" === "true"; 

      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay listWeek' 
        },
        events: {
          url: '/scheduled',
          method: 'GET',
          extraParams: function() {
            if (!isGlobalView && subscriptionId) {
              return { subscription_id: subscriptionId };
            }
            return {}; 
          },
          failure: function(error) {
            console.error("Error fetching scheduled webhooks:", error);
            alert('Error fetching scheduled webhooks!');
          }
        },
        eventDataTransform: function(eventData) {
          let title = eventData.recurrence && eventData.recurrence.String !== 'pending'
              ? `Recurring: ${eventData.recurrence.String}`
              : 'Scheduled';
          if (isGlobalView) {
            if (eventData.subscription_id && typeof eventData.subscription_id === 'string') {
                  title += ` (Sub: ${eventData.subscription_id.substring(0, 8)}...)`;
              } else {
                  title += ` (Sub: Unknown)`;
              }
          }
          return {
            id: eventData.id,
            title: title,
            start: eventData.scheduled_for,
            allDay: false,
            extendedProps: eventData
          };
        },
        eventClick: function(info) {
          var details = info.event.extendedProps;
          if (confirm(`Delete scheduled webhook ID: ${info.event.id}? \nSubscription: ${details.subscription_id}\nScheduled For: ${info.event.start.toLocaleString()}`)) {
            fetch('/scheduled/' + info.event.id, { method: 'DELETE' })
              .then(res => {
                if (!res.ok) {
                    return res.text().then(text => { throw new Error(text || 'Failed to delete') });
                }
                calendar.refetchEvents();
                alert('Scheduled webhook deleted.');
              })
              .catch(err => {
                  console.error("Error deleting webhook:", err);
                  alert('Error deleting webhook: ' + err.message);
              });
          }
        }
      });
      calendar.render();
    });
  </script>
</body>
</html>